@page "/"
@using BlazorApp.Models
@using Common.Classes
@using Common.Discord
@using Common.Pingg
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Options
@attribute [Authorize]
@inject IOptions<List<CameraConfig>> CamerasOptions
@inject PingService PingService
@inject ILogger<Home> Logger
@inject IDiscordWebHookService DiscordWebHookService
@rendermode InteractiveServer
@inject NavigationManager Navigation

<PageTitle>Cameras Monitor</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudStack Spacing="4" AlignItems="AlignItems.Center">

        @* Header *@
        <MudStack AlignItems="AlignItems.Center" Spacing="1">
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large" Class="gradient-primary">
                    <MudIcon Icon="@Icons.Material.Filled.Home" />
                </MudAvatar>
                <MudText Typo="Typo.h5" Class="fw-bold">The house of tonito !</MudText>
            </MudStack>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Les cameras</MudText>
        </MudStack>

        @* Bouton logout *@
        <MudButton Href="/logout"
                   Variant="Variant.Outlined"
                   Color="Color.Error"
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.Logout">
            Deconnexion
        </MudButton>

        @* Card principale *@
        <MudPaper Class="pa-6 glass-card" Elevation="0" Style="width: 100%;">
            <MudStack Spacing="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    Systeme de surveillance de renards, pigeons, pies, chats et autres trucs tres utiles.
                </MudText>

                @* Liste des cameras *@
                <MudStack Spacing="2">
                    @foreach (var camera in _cameras)
                    {
                        var status = _pingResults.GetValueOrDefault(camera.Name);
                        var isLoading = _loadingStates.GetValueOrDefault(camera.Name);

                        <MudPaper Class="pa-4 camera-card" Elevation="0">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="3">
                                <MudAvatar Color="Color.Primary" Size="Size.Large" Class="gradient-primary">
                                    <MudIcon Icon="@Icons.Material.Filled.Videocam" />
                                </MudAvatar>

                                <MudStack Spacing="0" Class="flex-grow-1">
                                    <MudText Typo="Typo.h6">@camera.Name</MudText>
                                    @if (isLoading)
                                    {
                                        <MudChip T="string" Color="Color.Warning" Size="Size.Small"
                                                 Icon="@Icons.Material.Filled.Sync" Class="status-chip">
                                            Ping en cours...
                                        </MudChip>
                                    }
                                    else if (status == true)
                                    {
                                        <MudChip T="string" Color="Color.Success" Size="Size.Small"
                                                 Icon="@Icons.Material.Filled.CheckCircle" Class="status-chip pulse-success">
                                            En ligne
                                        </MudChip>
                                    }
                                    else if (status == false)
                                    {
                                        <MudChip T="string" Color="Color.Error" Size="Size.Small"
                                                 Icon="@Icons.Material.Filled.Error" Class="status-chip">
                                            Hors ligne
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudChip T="string" Color="Color.Default" Size="Size.Small"
                                                 Icon="@Icons.Material.Filled.HelpOutline" Class="status-chip">
                                            Statut inconnu
                                        </MudChip>
                                    }
                                </MudStack>

                                <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                               Color="Color.Primary"
                                               Variant="Variant.Filled"
                                               Size="Size.Medium"
                                               OnClick="() => PingCamera(camera)"
                                               Disabled="isLoading" />
                                <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                               Color="Color.Secondary"
                                               Variant="Variant.Filled"
                                               Size="Size.Medium"
                                               Href="@camera.Url"
                                               Target="_blank"
                                               OnClick="() => LogToDiscord(camera)" />
                                <MudIconButton Icon="@Icons.Material.Filled.History"
                                               Color="Color.Primary"
                                               Variant="Variant.Filled"
                                               Size="Size.Medium"
                                               OnClick="() => RedirectToHistory(camera)"/>
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>

                @* Info banner *@
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.body2">Le chargement du flux peut prendre quelques secondes</MudText>
                </MudAlert>
            </MudStack>
        </MudPaper>

        @* Footer *@
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-4">
            Â© Tonito
        </MudText>
    </MudStack>
</MudContainer>
