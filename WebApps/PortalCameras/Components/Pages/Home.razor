@page "/"
@using BlazorApp.Models
@using Common.Classes
@using Common.Discord
@using Common.Pingg
@using Microsoft.AspNetCore.Authorization
@using Microsoft.Extensions.Options
@attribute [Authorize]
@inject IOptions<List<CameraConfig>> CamerasOptions
@inject PingService PingService
@inject ILogger<Home> Logger
@inject IDiscordWebHookService DiscordWebHookService
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@inject NavigationManager Navigation

<PageTitle>Cameras Monitor</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="py-8">
    <MudStack Spacing="4" AlignItems="AlignItems.Center">

        @* Header *@
        <MudStack AlignItems="AlignItems.Center" Spacing="1">
            <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large" Class="gradient-primary">
                    <MudIcon Icon="@Icons.Material.Filled.Home" />
                </MudAvatar>
                <MudText Typo="Typo.h5" Class="fw-bold">The house of tonito !</MudText>
            </MudStack>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Les cameras</MudText>
        </MudStack>

        @* Bouton logout *@
        <MudButton Href="/logout"
                   Variant="Variant.Outlined"
                   Color="Color.Error"
                   Size="Size.Small"
                   StartIcon="@Icons.Material.Filled.Logout">
            Deconnexion
        </MudButton>

        @* Card principale *@
        <MudPaper Class="pa-6 glass-card" Elevation="0" Style="width: 100%;">
            <MudStack Spacing="4">
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    Systeme de surveillance de renards, pigeons, pies, chats et autres trucs tres utiles.
                </MudText>

                @* Liste des cameras par groupe *@
                @foreach (var group in _cameras.GroupBy(c => c.Group))
                {
                    <MudStack Spacing="2">
                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2" Class="mt-3">
                            <MudDivider Class="group-divider" Style="flex: 1;" />
                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@(string.IsNullOrEmpty(group.Key) ? "Autres" : group.Key)</MudText>
                            <MudDivider Class="group-divider" Style="flex: 1;" />
                        </MudStack>

                        @foreach (var camera in group)
                        {
                            var status = _pingResults.GetValueOrDefault(camera.Name);
                            var isLoading = _loadingStates.GetValueOrDefault(camera.Name);

                            <MudPaper Class="pa-4 camera-card" Elevation="0">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="3">
                                    <MudIcon Icon="@Icons.Material.Filled.Videocam" />

                                    <MudStack Spacing="0" Class="flex-grow-1">
                                        <MudStack Row AlignItems="AlignItems.Center" Spacing="2">
                                            <MudText Typo="Typo.h6">@camera.Name</MudText>
                                            @if (isLoading)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Sync" Size="Size.Small" Color="Color.Warning" Class="status-dot" />
                                            }
                                            else if (status == true)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Success" Class="status-dot" />
                                            }
                                            else if (status == false)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Error" Class="status-dot" />
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Default" Class="status-dot" />
                                            }
                                        </MudStack>
                                    </MudStack>

                                    <MudStack Class="camera-actions" Spacing="0">
                                        <MudButton Color="Color.Secondary"
                                                   Variant="Variant.Text"
                                                   Size="Size.Small"
                                                   StartIcon="@Icons.Material.Filled.PlayCircle"
                                                   Href="@camera.Url"
                                                   Target="_blank"
                                                   OnClick="async () => await LogToDiscord(camera.Url)">
                                            Flux live
                                        </MudButton>

                                        <MudButton Color="Color.Primary"
                                                   Variant="Variant.Text"
                                                   Size="Size.Small"
                                                   StartIcon="@Icons.Material.Filled.History"
                                                   OnClick="() => NavigateToHistory(camera.Name)">
                                            Historique
                                        </MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                }

                @* Info banner *@
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.body2">Le chargement du flux peut prendre quelques secondes</MudText>
                </MudAlert>
            </MudStack>
        </MudPaper>

        @* Footer *@
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-4">
            Â© Tonito
        </MudText>
    </MudStack>
</MudContainer>
